# This Template builds a function app project, validates by running unit tests and publishes the code coverage.


parameters:
  - name: functionAppName
  - name: workingDirectory
  - name: projectName
  - name: projects
    type: object
    default: []
  - name: environmentServiceNameAzureRM
    
steps:

  - task: DotNetCoreCLI@2
    displayName: 'Build ${{ parameters.projectName }}'
    inputs:
      command: 'build'
      projects: '${{ parameters.projects }}'
      arguments: '--output ${{ parameters.workingDirectory}}/${{ parameters.projectName}}_output --configuration Release'
      

  - task: ArchiveFiles@2
    displayName: 'Archive ${{ parameters.projectName }}'
    inputs:
      rootFolderOrFile: '${{ parameters.workingDirectory}}/${{ parameters.projectName }}_output'
      includeRootFolder: true
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/build$(Build.BuildId).zip'
      replaceExistingArchive: true

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/build$(Build.BuildId).zip'
      ArtifactName: 'FunctionApp'
      publishLocation: 'Container'

  - task: AzureFunctionApp@2
    displayName: deploy the functions to function_app
    inputs:
      connectedServiceNameARM: '${{ parameters.environmentServiceNameAzureRM }}'
      appType: 'functionApp'
      appName: '${{ parameters.functionAppName }}'
      package: '$(Build.ArtifactStagingDirectory)/build$(Build.BuildId).zip'
      deploymentMethod: 'auto'
